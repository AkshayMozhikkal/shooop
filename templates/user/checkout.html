{% extends 'user/base.html' %}
{% load static %}
{% block content %}



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shooop Admin</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>

 <body>






    <div style="height: 100px;"></div>

    <!--================Checkout Area =================-->
    <section class="checkout_area section_gap">
        <div class="container">
            <!-- <div class="returning_customer">
            <div class="check_title">
                <h2>Returning Customer? <a href="#">Click here to login</a></h2>
            </div>
            <p>If you have shopped with us before, please enter your details in the boxes below. If you are a new
                customer, please proceed to the Billing & Shipping section.</p>
            <form class="row contact_form" action="#" method="post" novalidate="novalidate">
                <div class="col-md-6 form-group p_star">
                    <input type="text" class="form-control" id="name" name="name">
                    <span class="placeholder" data-placeholder="Username or Email"></span>
                </div>
                <div class="col-md-6 form-group p_star">
                    <input type="password" class="form-control" id="password" name="password">
                    <span class="placeholder" data-placeholder="Password"></span>
                </div>
                <div class="col-md-12 form-group">
                    <button type="submit" value="submit" class="primary-btn">login</button>
                    <div class="creat_account">
                        <input type="checkbox" id="f-option" name="selector">
                        <label for="f-option">Remember me</label>
                    </div>
                    <a class="lost_pass" href="#">Lost your password?</a>
                </div>
            </form>
        </div>-->
       
            <div class="billing_details">
                <div class="row">
                    <div class="col-lg-8">
                        <h3>Billing Details</h3>
                        <form class="row contact_form" action="{% url 'place_order' %}" method="post"
                            novalidate="novalidate">
                            {% csrf_token %}
                            <div class="col-md-6 form-group p_star">
                                <span>First name</span>
                                <input type="text" class="form-control" id="first" name="first_name"
                                    value="{{user.first_name}}">

                            </div>
                            <div class="col-md-6 form-group p_star">
                                <span for='last_name'>Last name</span>
                                <input type="text" class="form-control" id="last" name="last_name"
                                    value="{{user.last_name}}">
                            </div>

                            <div class="col-md-6 form-group p_star">
                                <span for='phone'>Phone No:</span>
                                <input type="text" class="form-control" id="number" name="phone"
                                    value="{{user.phone}}">
                            </div>

                            <div class="col-md-6 form-group p_star">
                                <span for='email'>email</span>
                                <input type="text" class="form-control" id="email" name="email"
                                    value="{{user.email}}">
                            </div>

                            <!--  Address Line Start -->
                            <div class="col-md-12 form-group p_star">
                                <h3>Addresses</h3>
                                <div class="row d-flex justify-content-between">
                                    {% for addr in address %}
                                    {% if addr.is_active %}
                                    <!-- Address Card Start -->

                                    <div class="card col d-flex d-flex justify-content-between" style="width: 18rem;">
                                        <div class="card-body">
                                            <h5 class="card-title">Address Field</h5>

                                            <h6 class="card-subtitle mb-2 text-muted">House No:</h6>
                                            <p class="card-text">{{addr.house}}</p>

                                            <h6 class="card-subtitle mb-2 text-muted">City:</h6>
                                            <p class="card-text">{{addr.city}}</p>

                                            <h6 class="card-subtitle mb-2 text-muted">State:</h6>
                                            <p class="card-text">{{addr.state}}</p>

                                            <h6 class="card-subtitle mb-2 text-muted">Zip:</h6>
                                            <p class="card-text">{{addr.zip}}</p>

                                            <h6 class="card-subtitle mb-2 text-muted">Country:</h6>
                                            <p class="card-text">{{addr.country}}</p>

                                            <a href="#" class="card-link text-decoration-none">Deliver Here</a>
                                            <input class="ml-3" type="radio" name="delivery_address"
                                                value="{{addr.id}}">
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>

                                <!-- Address Card End -->

                                <!-- Edit Address -->
                                <!-- <div class="col-md-6 form-group p_star">
                                <span for='house'>House No:</span>
                                <input type="text" class="form-control" id="first" name="house" value="{{addr.house}}">

                            </div>
                            <div class="col-md-6 form-group p_star">
                                <span for='city'>City</span>
                                <input type="text" class="form-control" id="last" name="city" value="{{addr.city}}">
                            </div>

                            <div class="col-md-6 form-group p_star">
                                <span for='state'>State</span>
                                <input type="text" class="form-control" id="number" name="state" value="{{addr.state}}">
                            </div>

                            <div class="col-md-6 form-group p_star">
                                <span for='zip'>Zip/PIN:</span>
                                <input type="text" class="form-control" id="email" name="zip" value="{{addr.zip}}">
                            </div>

                            <div class="col-md-6 form-group p_star">
                                <span for='country'>Country</span>
                                <input type="text" class="form-control" id="email" name="country"
                                    value="{{addr.country}}">
                            </div> -->
                                <!-- Edit Address End -->

                            </div>





                            <div class="col-md-12 form-group">
                                <div class="creat_account">
                                    <h3>Shipping Details</h3>

                                    <label for="f-option3">Ship to a different address?</label>
                                </div>


                                <!-- New Address -->
                                <a class="btn btn-secondary" href="" data-bs-toggle="modal"
                                    data-bs-target="#exampleModal3">--Add New Address--</a>
                                <!-- New Address End -->

                            </div>

                    </div>
                    <div class="col-lg-4">
                        <div class="order_box">
                            <h2>Your Order</h2>
                
                            <ul class="list">
                                <li><a href="#">Product <span>Total</span></a></li>
                                {% for item in cart %}
                                <li><a href="#">{{item.product_id.product.prod_name}} <span>x{{item.product_count}}   = Rs:{{item.total_price}}</span></a></li>
                                {% endfor %}

                            </ul><br>
                           

                            <ul class="list list_2 subtotal">
                                
                                <li><a href="#">Subtotal <span>Rs:{{total_price}}</span></a></li><br>
                                <span id="coupon_discounts"></span><br>
                                <span id="new_tot"></span>
                                <input type="number" name="new_price" id="new_price" hidden>
                                <input type="text" id="coupon_code2" name="coupon_code2"  hidden>
                            </ul>

                                <!-- Coupon Code Start -->

                                <div class="m-3">
                                    <div class="check_title ">
                                        <h6>Have a coupon? </h6>
                                    </div>
                                    <input class="form-control" id="coupon_code" type="text" placeholder="Enter coupon code">
                                    <a class="tp_btn" id="apply_coupon" >Apply Coupon</a>
                                </div> 
    
                                <!-- Coupon Code End -->
                            
                            <div class="payment_item">
                                <div class="radion_btn">
                                    <input type="radio" id="f-option5" name="selector" value="COD" required>
                                    <label for="f-option5">Cash On Delivery</label>
                                    <div class="check"></div>
                                </div>
                                {% comment %} <p>Please send a check to Store Name, Store Street, Store Town, Store
                                    State /
                                    County,
                                    Store Postcode.</p> {% endcomment %}
                            </div>
                            <div class="payment_item active">
                                <div class="radion_btn">
                                    <input type="radio" id="f-option6" name="selector" value="Paypal">
                                    <label for="f-option6">Paypal </label>
                                    <img src="img/product/card.jpg" alt="">
                                    <div class="check"></div>
                                </div>
                                <p>Pay via PayPal; you can pay with your credit card if you don’t have a PayPal
                                    account.</p>
                            </div>
                            <div class="creat_account">
                                <input type="checkbox" id="f-option4" name="terms" required>
                                <label for="f-option4">I’ve read and accept the </label>
                                <a href="#">terms & conditions*</a>
                            </div>
                            <!-- Start Messages Area -->
                            {% if messages %}
                            <div class="alert alert-danger alert-dismissible fade show h-auto" role="alert"
                                style="position: relative;">
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"
                                    aria-label="Close"></button>
                                {% for message in messages %}
                                <strong>{{ message }}</strong><br>
                                {% endfor %}
                            </div>
                            <script>
                                let closeButton = document.querySelector('.alert button');
                                closeButton.addEventListener('click', function () {
                                    let alertBox = this.parentElement;
                                    alertBox.style.display = 'none';
                                });
                            </script>

                            {% endif %}

                            <!-- End  Messages Area -->

                            <input type="number" id="order_total" name="order_total" value="{{total_price}}" hidden>
                            <button class="primary-btn" type="submit">Order Now</button>
                            <button class="btn btn-primary payWithRazorpay m-3" type="submit">Razorpay</button>
                            </form>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--================End Checkout Area =================-->


    <!-- Address Modal Start-->

    <div class="modal" id="exampleModal3" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="{% url 'add_address'  %}" method='POST'>
                        {% csrf_token %}

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="" name="house1" required value=""
                                placeholder="House No" onfocus="this.placeholder = ''"
                                onblur="this.placeholder = 'House No'">
                        </div>

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="" name="city1" placeholder="City" required
                                value="" onfocus="this.placeholder = ''" onblur="this.placeholder = 'City'">
                        </div>

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="" name="state1" placeholder="State" value=""
                                required onfocus="this.placeholder = ''" onblur="this.placeholder = 'State'">
                        </div>

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="" name="zip1" placeholder="Zip Code" value=""
                                required onfocus="this.placeholder = ''" onblur="this.placeholder = 'Zip Code'">
                        </div>

                        <div class="col-md-12 form-group">
                            <input type="text" class="form-control" id="" name="country1" value="" required
                                placeholder="Country" onfocus="this.placeholder = ''"
                                onblur="this.placeholder = 'Country'">
                        </div>

                        <div class="col-md-12 form-group">
                            <button type="submit" value="Save" class="primary-btn">Save
                                Address</button>
                        </div>
                    </form>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Modal End -->
</body>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>


<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


   <!-- Sweet Alertt -->   
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

 <!-- Coupon Apply Start -->

 <script>
    $(document).ready(function() {
      $(document).on('click', '#apply_coupon', function(e) {
        e.preventDefault();
        var coupon_code = document.getElementById('coupon_code').value;
        var order_total = document.getElementById('order_total').value;
        console.log(coupon_code, order_total)
    
        $.ajax({
          method: "POST",
          url: "/apply_coupon/",

          data: {
            'coupon_code': coupon_code,
            'order_total':order_total,
            csrfmiddlewaretoken: '{{csrf_token}}'
          },

          success: function(response) {
            console.log(response);
            alertify.error(response.status);
            
            document.getElementById('new_tot').innerHTML = "Discounted Price: Rs."+response.new_total;
            document.getElementById('new_price').value = response.new_total;
            document.getElementById('coupon_code2').value = response.coupon_code;
            document.getElementById('coupon_discounts').innerHTML = "Coupon Discount: Rs."+response.coupon_discount;
            
            // $('.subtotal').load(location.href + " .subtotal");
    
          }
        });
      });
    });
    </script>
    <!-- Coupon Apply End  -->

  <!-- Razor Pay Start -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      $(document).ready(function () {
       
        $('.payWithRazorpay').click(function (e) {
          e.preventDefault();
          var fname = $("[name='first_name']").val()
          var lname = $("[name='last_name']").val()
          var phone = $("[name='phone']").val()
          var email  = $("[name='email']").val()
          var new_price = $("[name='new_price']").val()
          var coupon_code2 = $("[name='coupon_code2']").val()
          var address = $("[name='delivery_address']").val()
          var token = $("[name='csrfmiddlewaretoken']").val()
          var selectedAddress = $("input[name='delivery_address']:checked").val();

          console.log(new_price, coupon_code2)
          if(!phone || phone=="0")
          {
            swal("Alert!", "Phone Number required!", "error");
            console.log('Contact Number Empty');
            return false;
    
          }
          if(!selectedAddress)
          {
            swal("Alert!", "Address fields is mandatory!", "error");
            console.log('Address fields are empty');
            return false;
    
          }
          else
          
          {
            $.ajax({
               method:"GET",
               url:"{% url 'proceedtopay' %}",
               data:{'new_price':new_price,
                      'coupon_code2':coupon_code2,
                      csrfmiddlewaretoken: token },

               success: function(response) {
                console.log(response,"hhhhh")
                var options = {
                  "key": "rzp_test_mwD4P8NcbZNoSv", // Enter the Key ID generated from the Dashboard
                  "amount": response.total_price*1,//response.total_price * 100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                  "currency": "INR",
                  "name": "SHOOOP",
                  "description": "Thank you for buying with us..!",
                  "image": "{% static 'user/img/Logoos/shoe1.png' %}",
                  //"order_id": "order_IluGWxBm9U8zJ8", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                  "handler": function (responseb){
                    // alert(responseb.razorpay_payment_id);
                      data = {
                                'first_name': fname,
                                'selector': 'Razorpay',
                                'new_price' : new_price,
                                'coupon_code2':coupon_code2,
                                "delivery_address": address,
                                csrfmiddlewaretoken: token
                        
                      }
                        $.ajax({
                          method:"POST",
                          url:"{% url 'place_order' %}",
                          data: data,
                          success: function (responsec) {
                            console.log(responsec.status,"kkkkk")
                            swal("Congratulations!", responsec.status,"success").then((value) => {
                                window.location.href = '/my_orders/';
                            });
                          }
    
                      });
                  },
                  "prefill": {
                      'name': fname+" "+lname,
                      'email' : email,
                      'contact' : phone,
                  },
                  
                  "theme": {
                      "color": "#3399cc"
                  }
              };
              var rzp1 = new Razorpay(options);
              rzp1.on('payment.failed', function (response){
                      alert(response.error.code);
                      alert(response.error.description);
                      alert(response.error.source);
                      alert(response.error.step);
                      alert(response.error.reason);
                      alert(response.error.metadata.order_id);
                      alert(response.error.metadata.payment_id);
              });
              rzp1.open();
                console.log(responsec);
    
               }
            });
             
          }
          
        });
    
      });
    </script>
  <!-- Razor Pay End -->
  

 
  </html> 

{% endblock %}